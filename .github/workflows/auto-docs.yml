name: Auto-Generate Release Notes

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string
      since_tag:
        description: 'Previous tag to compare from (optional)'
        required: false
        type: string
      api_provider:
        description: 'API provider to use'
        required: true
        type: choice
        options:
          - cerebras
          - openrouter
          - anthropic
          - openai
          - groq
        default: cerebras
      enable_polish:
        description: 'Enable 2-stage polish workflow (discovery + refinement)'
        required: false
        type: boolean
        default: true

jobs:
  generate-release-notes:
    name: Generate AI Release Notes
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install promptext-notes from source
        run: |
          # Install directly from the repo (fast due to Go module cache)
          go install ./cmd/promptext-notes
          # Make it available in PATH
          echo "$HOME/go/bin" >> $GITHUB_PATH
          promptext-notes --help

      - name: Determine version and previous tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT

            # Get previous tag
            PREV_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")
            echo "since_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          else
            # Manual workflow dispatch
            VERSION="${{ inputs.version }}"
            SINCE_TAG="${{ inputs.since_tag }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "since_tag=$SINCE_TAG" >> $GITHUB_OUTPUT
          fi

          echo "üè∑Ô∏è  Version: $VERSION"
          echo "üìç Previous tag: ${SINCE_TAG:-auto-detect}"

      - name: Select API provider
        id: api
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Use Cerebras by default for tag pushes (higher free tier rate limits)
            API_PROVIDER="cerebras"
          else
            API_PROVIDER="${{ inputs.api_provider }}"
          fi
          echo "provider=$API_PROVIDER" >> $GITHUB_OUTPUT
          echo "ü§ñ Using API provider: $API_PROVIDER"

      - name: Generate release notes with AI
        id: generate
        env:
          # API Keys
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SINCE_TAG="${{ steps.version.outputs.since_tag }}"
          API_PROVIDER="${{ steps.api.outputs.provider }}"

          # Determine model based on provider (use GitHub Variables or defaults)
          case "$API_PROVIDER" in
            openai)
              MODEL="${{ vars.OPENAI_MODEL }}"
              MODEL="${MODEL:-gpt-4o-mini}"
              ;;
            anthropic)
              MODEL="${{ vars.ANTHROPIC_MODEL }}"
              MODEL="${MODEL:-claude-haiku-4-5}"
              ;;
            cerebras)
              MODEL="${{ vars.CEREBRAS_MODEL }}"
              MODEL="${MODEL:-llama-3.3-70b}"  # Best free model (9/10 quality)
              ;;
            groq)
              MODEL="${{ vars.GROQ_MODEL }}"
              MODEL="${MODEL:-llama-3.3-70b-versatile}"
              ;;
            openrouter)
              MODEL="${{ vars.OPENROUTER_MODEL }}"
              MODEL="${MODEL:-google/gemini-2.5-flash}"  # Best quality/cost ratio
              ;;
            *)
              MODEL=""
              ;;
          esac

          # Build command using config file (GLM + Claude Sonnet 4.5)
          CMD="promptext-notes --generate --output release-notes.md --version $VERSION"

          # Add since tag if available
          if [ -n "$SINCE_TAG" ]; then
            CMD="$CMD --since $SINCE_TAG"
          fi

          # Enable polish workflow for tag pushes (uses config: GLM discovery + Claude Sonnet polish)
          if [ "${{ github.event_name }}" = "push" ]; then
            CMD="$CMD --polish"
            echo "‚ú® 2-stage polish workflow enabled: GLM (discovery) + Claude Sonnet 4.5 (polish)"
          elif [ "${{ inputs.enable_polish }}" = "true" ]; then
            CMD="$CMD --polish"
            echo "‚ú® 2-stage polish workflow enabled"
          fi

          echo "üöÄ Running: $CMD"
          $CMD

          if [ -f release-notes.md ]; then
            echo "notes_file=release-notes.md" >> $GITHUB_OUTPUT
            echo "‚úÖ Release notes generated successfully"
          else
            echo "‚ùå Failed to generate release notes"
            exit 1
          fi

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        if: github.event_name == 'push'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if this version already exists in CHANGELOG
          if [ -f CHANGELOG.md ] && grep -q "^## \[$VERSION\]" CHANGELOG.md; then
            echo "‚ö†Ô∏è  Version $VERSION already exists in CHANGELOG.md"
            echo "   Removing old entry and replacing with new one..."

            # Create a temporary file excluding the existing version section
            awk -v ver="$VERSION" '
              /^## \[/ {
                in_section = 0
                if ($0 ~ "^## \\[" ver "\\]") {
                  in_section = 1
                  next
                }
              }
              /^---$/ && in_section {
                in_section = 0
                next
              }
              !in_section { print }
            ' CHANGELOG.md > CHANGELOG-filtered.md

            # Use filtered version as base
            mv CHANGELOG-filtered.md CHANGELOG.md
          fi

          # Strip the "# Release Notes for vX.X.X" header if present
          # Keep only from "## [vX.X.X]" onwards
          if grep -q "^# Release Notes for" release-notes.md; then
            sed -n '/^## \[/,$p' release-notes.md > release-notes-clean.md
          else
            cp release-notes.md release-notes-clean.md
          fi

          # Create temp file with new release notes
          cat release-notes-clean.md > temp-changelog.md
          echo "" >> temp-changelog.md
          echo "---" >> temp-changelog.md
          echo "" >> temp-changelog.md

          # Append existing CHANGELOG if it exists, but skip the header
          if [ -f CHANGELOG.md ]; then
            # Skip the "# Changelog" header and "All notable changes..." intro
            sed -n '/^## \[/,$p' CHANGELOG.md >> temp-changelog.md
          fi

          # Add header at the top
          {
            echo "# Changelog"
            echo ""
            echo "All notable changes to this project will be documented in this file."
            echo ""
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)."
            echo ""
            echo "---"
            echo ""
            cat temp-changelog.md
          } > CHANGELOG.md

          # Cleanup
          rm -f release-notes-clean.md temp-changelog.md

          echo "üìù Updated CHANGELOG.md with release notes"

      - name: Commit CHANGELOG.md
        if: github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update CHANGELOG for ${{ steps.version.outputs.version }}"
            git push origin HEAD:main
            echo "‚úÖ Pushed CHANGELOG.md to main branch"
          fi

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ steps.version.outputs.version }}
          path: release-notes.md
          retention-days: 90
